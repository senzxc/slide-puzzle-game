<!DOCTYPE html>
<html lang="en">
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />
    <meta
      property="og:image"
      content="https://senzxc.github.io/slide-puzzle-game/assets/mika.jpg"
    />
    <title>Puzzle Game</title>
    <style>
      html,
      body {
        touch-action: manipulation;
      }

      body {
        height: 83vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: Arial, sans-serif;
        text-align: center;
        margin-top: 40px;
        background-color: #121212;
        overflow: hidden;
      }

      #icon {
        width: 250px;
        margin-bottom: 20px;
      }

      h1 {
        color: #ffffff;
        font-size: 24px;
      }

      h2 {
        color: #ffffff;
        font-size: 18px;
        margin-bottom: 20px;
      }

      button {
        background-color: #333;
        border: 2px solid #5a5a5a;
        color: #ffffff;
        border-radius: 10px;
        cursor: pointer;
        font-size: 16px;
      }
      button:hover {
        background-color: #444;
      }
      #stopwatch {
        color: #ffffff;
      }

      #puzzle-container {
        display: none;
        position: relative;
        width: 312px; /* 3 x (100 + 4) - 4 */
        height: 312px;
        margin: 20px auto;
        border: 2px solid #5a5a5a;
      }

      .tile {
        position: absolute;
        width: 100px;
        height: 100px;
        /* background-image: url("assets/hutao.jpeg"); */
        background-size: 300px 300px;
        background-repeat: no-repeat;
        border-radius: 5px;
        cursor: pointer;
        transition: transform 0.25s ease;
        will-change: transform;
        -webkit-tap-highlight-color: transparent;
      }

      h3 {
        display: none;
        color: #ffffff;
        font-size: 20px;
        margin-top: 20px;
      }

      #menu {
        display: none;
        justify-content: center;
        max-width: 500px;
        flex-wrap: wrap;
        margin-top: 20px;
        gap: 20px;
      }

      #menu a {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: #ffffff;
        text-align: center;
        overflow: hidden;
        position: relative;
      }

      #menu a:hover img {
        transform: scale(1.1);
      }

      #menu img {
        width: 100px;
        transition: transform 0.2s ease;
      }

      #menu span {
        display: block;
        transform: translateY(-100%);
        opacity: 0;
        transition: transform 0.3s ease, opacity 0.3s ease;
        font-size: 14px;
        margin-top: 15px;
      }

      #menu a:hover span {
        transform: translateY(0);
        opacity: 1;
      }

      #backBtn {
        display: none;
        background-color: #333;
        border: 2px solid #5a5a5a;
        color: #ffffff;
        border-radius: 10px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 20px;
      }
      #backBtn:hover {
        background-color: #444;
      }

      button {
        padding: 10px 20px;
        margin: 10px;
      }

      #stopwatch {
        display: none;
        color: #ffffff;
        font-size: 1rem;
        margin-top: 10px;
      }

      #resetBtn {
        display: none;
      }

      #win-text {
        font-size: 1rem;
        margin-top: 10px;
        color: lawngreen;
      }

      #countdown {
        font-size: 1rem;
        font-weight: bold;
        margin-top: 10px;
        color: #ffffff;
      }

      @media (max-width: 600px) {
        body {
          height: 90vh;
          margin-top: 20px;
        }

        #menu span {
          display: block;
          transform: translateY(0);
          font-size: 14px;
          margin-top: 15px;
        }

        #menu a span {
          transform: translateY(1);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <img id="icon" src="assets/carlotta.png" />
    <h1 id="title">Puzzle Gambar 3x3</h1>
    <h2 id="creator">Created by senzxc</h2>
    <button id="startBtn" onclick="selectImg()">Mulai</button>
    <button id="resetBtn" onclick="resetToInitial()">Reset</button>
    <div id="stopwatch">Waktu: 0 detik</div>
    <div id="countdown"></div>

    <div id="puzzle-container"></div>

    <h3 id="menu-title">Pilih Gambar</h3>

    <div id="menu">
      <a href="" data-image="assets/mika.jpg">
        <img src="assets/mika-preview.png" alt="Mika Preview" />
        <span>Mika</span>
      </a>

      <a href="" data-image="assets/hutao.jpeg">
        <img src="assets/hutao-preview.png" alt="Hutao Preview" />
        <span>Hutao</span>
      </a>

      <a href="" data-image="assets/phrolova.jpg">
        <img src="assets/phrolova-preview.png" alt="Phrolova Preview" />
        <span>Phrolova</span>
      </a>

      <a href="" data-image="assets/mujica.png">
        <img src="assets/mujica-preview.png" alt="Mujica Preview" />
        <span>Mujica</span>
      </a>
    </div>

    <button id="backBtn" onclick="goBack()">Kembali</button>

    <div id="win-text"></div>

    <script>
      selectedImage =
        localStorage.getItem("selectedImage") || "assets/mika.jpg";

      const size = 3;
      const tileSize = 100;
      const gap = 2;
      const total = size * size;
      let tiles = [];
      let initialTiles = [];
      let emptyIndex = total - 1;
      let isPlaying = false;
      let isReady = false;
      let timerInterval;
      let seconds = 0;
      let countdownTimeout;

      function selectImg() {
        const menu = document.querySelector("#menu");
        menu.style.display = "flex";
        document.getElementById("startBtn").style.display = "none";
        document.getElementById("icon").style.display = "none";
        document.getElementById("title").style.display = "none";
        document.getElementById("creator").style.display = "none";
        document.getElementById("menu-title").style.display = "block";
        document.getElementById("backBtn").style.display = "inline-block";
      }

      function goBack() {
        document.querySelector("#menu").style.display = "none";
        document.getElementById("startBtn").style.display = "inline-block";
        document.getElementById("icon").style.display = "inline-block";
        document.getElementById("title").style.display = "inline-block";
        document.getElementById("creator").style.display = "inline-block";
        document.getElementById("menu-title").style.display = "none";
        document.getElementById("backBtn").style.display = "none";
      }

      function startGame() {
        initTiles();
        renderTiles();
        isReady = false;
        isPlaying = false;
        document.getElementById("resetBtn").style.display = "none";
        document.getElementById("startBtn").style.display = "none";
        document.getElementById("stopwatch").style.display = "none";
        document.getElementById("win-text").textContent = "";
        document.getElementById("title").style.display = "none";
        document.getElementById("icon").style.display = "none";
        document.getElementById("creator").style.display = "none";
        document.getElementById("menu-title").style.display = "none";
        document.getElementById("menu").style.display = "none";
        document.getElementById("backBtn").style.display = "none";
        document.getElementById("puzzle-container").style.display =
          "inline-block";

        document.getElementById("countdown").textContent = "Mulai dalam 3...";
        let countdown = 3;

        const countdownInterval = setInterval(() => {
          countdown--;
          if (countdown > 0) {
            document.getElementById(
              "countdown"
            ).textContent = `Mulai dalam ${countdown}...`;
          } else {
            clearInterval(countdownInterval);
            document.getElementById("countdown").textContent = "";
            shuffleTiles();
            renderTiles();
            isReady = true;
            isPlaying = true;
            seconds = 0;
            updateStopwatch();
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
              seconds++;
              updateStopwatch();
            }, 1000);
            document.getElementById("startBtn").style.display = "none";
            document.getElementById("title").style.display = "none";
            document.getElementById("stopwatch").style.display = "inline-block";
            document.getElementById("resetBtn").style.display = "inline-block";
          }
        }, 1000);
      }

      function resetToInitial() {
        initTiles();
        renderTiles();
        clearInterval(timerInterval);
        seconds = 0;
        updateStopwatch();
        isReady = false;
        isPlaying = false;

        document.getElementById("startBtn").style.display = "inline-block";
        document.getElementById("resetBtn").style.display = "none";
        document.getElementById("stopwatch").style.display = "none";
        document.getElementById("win-text").textContent = "";
        document.getElementById("countdown").textContent = "";
        document.getElementById("title").style.display = "inline-block";
        document.getElementById("icon").style.display = "inline-block";
        document.getElementById("creator").style.display = "inline-block";
        document.getElementById("puzzle-container").style.display = "none";
      }

      function updateStopwatch() {
        document.getElementById(
          "stopwatch"
        ).textContent = `Waktu: ${seconds} detik`;
      }

      function initTiles() {
        tiles = [];
        for (let i = 0; i < total - 1; i++) {
          tiles.push(i + 1);
        }
        tiles.push(null);
        emptyIndex = total - 1;
        initialTiles = [...tiles];
      }

      function shuffleTiles(times = 100) {
        for (let i = 0; i < times; i++) {
          const movable = getMovableIndexes();
          const rand = movable[Math.floor(Math.random() * movable.length)];
          moveTile(rand, true);
        }
      }

      function renderTiles() {
        const container = document.getElementById("puzzle-container");
        container.innerHTML = "";

        for (let i = 0; i < tiles.length; i++) {
          const value = tiles[i];
          if (value === null) continue;

          const tile = document.createElement("div");
          tile.style.backgroundImage = `url('${selectedImage}')`;
          tile.className = "tile";
          tile.textContent = "";
          const bgRow = Math.floor((value - 1) / size);
          const bgCol = (value - 1) % size;
          tile.style.backgroundPosition = `${-bgCol * tileSize}px ${
            -bgRow * tileSize
          }px`;

          tile.dataset.index = i;
          tile.dataset.value = value;

          tile.addEventListener("click", () => {
            const currentIndex = parseInt(tile.dataset.index);
            moveTile(currentIndex);
          });

          document.getElementById("puzzle-container").appendChild(tile);
        }

        updatePositions();
        isPlaying = true;
      }

      function updatePositions() {
        const tilesDom = document.querySelectorAll(".tile");
        tilesDom.forEach((tile) => {
          const index = tiles.indexOf(parseInt(tile.dataset.value));
          tile.dataset.index = index;
          const row = Math.floor(index / size);
          const col = index % size;
          const x = col * (tileSize + gap);
          const y = row * (tileSize + gap);
          tile.style.transform = `translate(${x}px, ${y}px)`;
        });
      }

      function getMovableIndexes() {
        const emptyRow = Math.floor(emptyIndex / size);
        const emptyCol = emptyIndex % size;

        const directions = [
          { r: -1, c: 0 },
          { r: 1, c: 0 },
          { r: 0, c: -1 },
          { r: 0, c: 1 },
        ];

        const indexes = [];

        directions.forEach((d) => {
          const newRow = emptyRow + d.r;
          const newCol = emptyCol + d.c;
          if (newRow >= 0 && newRow < size && newCol >= 0 && newCol < size) {
            indexes.push(newRow * size + newCol);
          }
        });

        return indexes;
      }

      function moveTile(index, isShuffling = false) {
        if (!isReady && !isShuffling) return;
        if (!getMovableIndexes().includes(index)) return;

        [tiles[index], tiles[emptyIndex]] = [tiles[emptyIndex], tiles[index]];
        emptyIndex = index;
        updatePositions();

        if (!isShuffling && isPlaying) {
          checkSolved();
        }
      }

      function checkSolved() {
        const correct = Array.from(
          { length: total - 1 },
          (_, i) => i + 1
        ).concat(null);
        const isSolved = tiles.every((val, i) => val === correct[i]);
        if (isSolved) {
          clearInterval(timerInterval);
          isPlaying = false;
          document.getElementById("win-text").textContent =
            "ðŸŽ‰ Puzzle selesai dalam " + seconds + " detik!";
          document.getElementById("win-text").style.display = "block";
        }
      }

      document.querySelectorAll("#menu a").forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const imgSrc = link.getAttribute("data-image");
          selectedImage = imgSrc;
          localStorage.setItem("selectedImage", selectedImage);
          startGame();
        });
      });

      initTiles();
      renderTiles();
    </script>
  </body>
</html>
